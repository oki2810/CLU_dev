<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="robots" content="noindex,nofollow">
  <title>CCU Logs</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    #log-list {
      border: 1px solid #000;
      border-radius: .25rem;
      padding: 0;
    }
    #log-list .list-group-item {
      border: none;
      border-top: 1px dashed #000;
      margin: 0;
      border-radius: 0;
    }
    #log-list .list-group-item:first-child {
      border-top: none;
    }
    .dragElem { opacity: 0.4; }
    .over-top { border-top: 3px solid #007bff !important; }
  </style>
</head>
<body class="container py-5">
  <h2 class="mb-4">アップロード済みログ</h2>
  <ul id="log-list" class="list-group">
    <!-- entries inserted server side -->
  </ul>
  <button id="saveOrderBtn" class="btn btn-primary mt-3">保存</button>

  <script src="norobot.js"></script>
  <script>
    const API_BASE = 'https://ccfolia-log-uploader.vercel.app';
    const list = document.getElementById('log-list');
    const saveBtn = document.getElementById('saveOrderBtn');
    let dragSrcEl = null;
    const deleted = new Set();

    function handleDragStart(e) {
      dragSrcEl = this;
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', '');
      this.classList.add('dragElem');
    }
    function handleDragOver(e) {
      e.preventDefault();
      return false;
    }
    function handleDragEnter() { this.classList.add('over-top'); }
    function handleDragLeave() { this.classList.remove('over-top'); }
    function handleDrop(e) {
      e.stopPropagation();
      if (dragSrcEl !== this) {
        const rect = this.getBoundingClientRect();
        const offset = e.clientY - rect.top;
        if (offset > rect.height / 2) {
          list.insertBefore(dragSrcEl, this.nextElementSibling);
        } else {
          list.insertBefore(dragSrcEl, this);
        }
      }
      return false;
    }
    function handleDragEnd() {
      this.classList.remove('dragElem');
      list.querySelectorAll('.list-group-item').forEach(item => {
        item.classList.remove('over-top');
      });
    }
    function addDnD(item) {
      item.setAttribute('draggable', 'true');
      item.addEventListener('dragstart', handleDragStart);
      item.addEventListener('dragover', handleDragOver);
      item.addEventListener('dragenter', handleDragEnter);
      item.addEventListener('dragleave', handleDragLeave);
      item.addEventListener('drop', handleDrop);
      item.addEventListener('dragend', handleDragEnd);
    }
    function addDelete(btn) {
      btn.addEventListener('click', () => {
        const li = btn.closest('.list-group-item');
        const path = li.querySelector('a')?.getAttribute('href');
        if (confirm('削除しますか？')) {
          if (path) deleted.add(path);
          list.removeChild(li);
        }
      });
    }

    function init() {
      Array.from(list.children).forEach(li => {
        addDnD(li);
        const btn = li.querySelector('.delete-btn');
        if (btn) addDelete(btn);
      });
    }

    saveBtn.addEventListener('click', async () => {
      const items = [];
      list.querySelectorAll('.list-group-item').forEach(li => {
        const scenarioName = li.querySelector('.text-muted')?.textContent || '';
        const linkEl = li.querySelector('a');
        if (!linkEl) return;
        items.push({
          scenarioName,
          linkText: linkEl.textContent,
          path: linkEl.getAttribute('href')
        });
      });
      const { owner, repo } = (() => {
        const hostParts = location.hostname.split('.');
        const owner = hostParts[0];
        const pathParts = location.pathname.split('/').filter(Boolean);
        const repo = pathParts[0];
        return { owner, repo };
      })();
      try {
        const res = await fetch(`${API_BASE}/api/update-index`, {
          method: 'POST',
          credentials: 'include',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ owner, repo, items, deletePaths: Array.from(deleted) })
        });
        const result = await res.json();
        if (result.ok) {
          alert('保存しました');
          deleted.clear();
        } else {
          alert('エラー: ' + result.error);
        }
      } catch (err) {
        alert('通信エラーが発生しました');
      }
    });

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
